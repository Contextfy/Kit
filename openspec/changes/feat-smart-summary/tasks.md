# 任务清单：feat-smart-summary

## 实施任务

### Task-01: 实现提取逻辑 ✅
- **上下文**：`packages/core/src/parser/mod.rs`
- **状态**：已完成
- **动作**：
  - [x] 实现公共辅助函数 `pub fn extract_summary(content: &str) -> String`
  - [x] **处理代码块逻辑**：
    - 检测内容是否以代码块开始（```）
    - 如果是，扫描直到找到关闭的 ```，将整个代码块包含在摘要中
  - [x] **处理双换行符逻辑**：
    - 查找第一个 `\n\n`（段落分隔符）
    - 确保截断点不在代码块内部
  - [x] **硬截断保护**（防止超长段落）：
    - 使用 `char_indices()` 追踪字符位置
    - 如果提取的内容超过 **1000 字符**，强制截断
    - 截断时尝试在最后一个完整句子（`.`、`!`、`?`）处断开
    - 如果找不到句子结束符，直接在 1000 字符处截断并添加 `...`
  - [x] **回退机制**：
    - 如果未找到段落分隔符或文本过短，使用现有行为（截取前 200 字符）
  - [x] **清理空白**：去除首尾空白字符
  - [x] **添加单元测试**（在 parser 模块内部）：
    - 测试普通文本段落（包含 `\n\n`）
    - 测试以代码块开始的内容（验证完整代码块被保留）
    - 测试代码块内部的双换行（不应截断）
    - 测试无段落分隔的短文本（回退到 200 字符）
    - 测试空内容边界情况
    - **测试超长段落（Wall of Text）**：
      - 输入 2000 字符的单一段落 → 验证截断到 ~1000 字符
      - 输入超长代码块 → 验证完整保留代码块但限制总长度
      - 验证截断时添加 `...` 后缀

### Task-02: 集成与重构 ✅
- **上下文**：`packages/core/src/parser/mod.rs`, `packages/core/src/storage/mod.rs`
- **状态**：已完成
- **动作**：
  - [x] 修改 `parse_markdown` 函数，在创建 `ParsedDoc` 结构体时调用 `extract_summary()`（第 225 行）
  - [x] 修改存储层 `KnowledgeStore::add()`，在创建切片记录时调用 `extract_summary()`（第 259 行）
  - [x] 验证现有的所有测试仍然通过（26 个单元测试 + 2 个集成测试）
  - [x] 移除旧的 `.chars().take(200).collect()` 调用
  - [x] 更新 `Brief` 结构体的文档注释（`packages/core/src/retriever/mod.rs` 第 14 行）

### Task-03: 验证与测试 ✅
- **上下文**：`packages/core/tests/`
- **状态**：已完成
- **动作**：
  - [x] 添加集成测试 `integration_summary_test.rs`，验证摘要在语义上正确
  - [x] **关键测试用例已验证**：
    - 切片以函数签名（代码块）开始 → 摘要包含完整签名 ✅
    - 文本 + 换行 + 文本 → 仅使用第一部分 ✅
    - 短文本无换行 → 回退行为正常工作 ✅
    - Wall of Text 保护 → 超长段落截断到 1000 字符 ✅
    - 代码块内部双换行 → 不会在代码块中间截断 ✅
  - [x] 运行完整的测试套件：**28 个测试全部通过**（26 个单元测试 + 2 个集成测试）
  - [x] 手动测试：使用真实 markdown 文件验证摘要质量
  - [x] 验证 `scout` 命令显示改进后的摘要：
    - 创建测试 `test_scout_summary.rs` 验证 CLI 检索功能
    - 确认代码块摘要包含完整的函数签名和返回类型
    - 确认长段落被正确截断到 ~1000 字符
    - **测试结果：通过** ✅

## 依赖关系

- 无新增外部依赖
- 无数据结构或 API 变更（向后兼容）

