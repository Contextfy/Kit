# 提案：智能摘要提取

## 为什么

当前 Contextfy 的摘要提取逻辑使用简单粗暴的方式：直接截取内容的前 200 个字符。这导致了几个问题：

1. **中途断句**：摘要经常在句子中间截断，难以阅读和理解
2. **信息不完整**：重要信息往往在 200 字符限制之后，被完全丢失
3. **代码块被截断**：对于以函数签名或代码块开始的文档，摘要会丢失关键的代码上下文
4. **Scout 结果差**：用户使用 `scout` 命令查找相关文档时，得到的摘要毫无帮助
5. **超长段落风险**：如果用户粘贴了 5000 字的日志或不换行文本，会撑爆 UI 和浪费 Token

### 当前问题示例

对于一个以函数签名开始的章节：

```markdown
## Authentication

```rust
pub async fn authenticate(
    api_key: String,
    timestamp: u64
) -> Result<AuthContext>
```

To use the API, you need to authenticate...
```

当前摘要（200 字符）只会包含函数签名的前几行，丢失完整的类型签名和返回类型，这对于开发者理解 API 极不友好。

## 变更内容

本变更通过**语义化首段提取**替代字符截断，改进摘要提取逻辑：

### 核心逻辑

1. **双换行符检测**：查找第一个 `\n\n`（段落分隔符）
2. **代码块特殊处理**（关键）：
   - 如果内容以代码块开始（```），摘要必须包含**整个代码块**，即使其中包含换行
   - 扫描直到找到关闭的 ```，将整个代码块纳入摘要
3. **截断点判断**：如果找到段落分隔符且不在代码块内，在此处截断
4. **硬截断保护**（防止超长段落）：
   - 使用 `char_indices()` 追踪字符位置
   - 如果提取的内容超过 **1000 字符**，强制截断
   - 截断时尝试在最后一个完整句子（`.`、`!`、`?`）处断开
   - 如果找不到句子结束符，直接在 1000 字符处截断并添加 `...`
5. **回退机制**：如果未找到段落分隔符或文本过短，回退到现有行为（截取前 200 字符）
6. **清理空白**：去除首尾空白字符

### 应用范围

- **文档级摘要**：`ParsedDoc.summary`（整篇文档的摘要）
- **切片级摘要**：`SlicedDoc.summary`（H2 切片的摘要）

### 收益

- **可读的摘要**：用户看到完整的思路和句子
- **保留代码上下文**：以代码块开始的切片保留完整的函数/类签名
- **更好的 Scout 体验**：搜索结果显示有意义、可操作的摘要
- **零外部依赖**：纯文本提取，无需 LLM 或 API 调用

### 关键场景示例

#### 场景 A：普通文本段落

```text
输入："这是第一段。\n\n这是第二段..."
输出："这是第一段。"
```

#### 场景 B：以代码块开始

```markdown
输入："```rust\npub fn foo() -> Bar\n```\n\n一些说明文字..."
输出："```rust\npub fn foo() -> Bar\n```"
```

#### 场景 C：无段落分隔

```text
输入："短文本或没有双换行的长文本..."
输出："前 200 字符（回退到现有行为）"
```

#### 场景 D：超长段落（Wall of Text 保护）

```text
输入："2000 字符的单一段落，从不换行..."
输出："前 ~1000 字符（在最后一个完整句子处截断，或添加 ...）"
```

#### 场景 E：超长代码块

```markdown
输入："```rust\n// 500 行的代码实现\n...\n```"
输出："完整代码块，但如果超过 1000 字符则截断并添加 ..."
```

## 替代方案考虑

1. **LLM 生成摘要**：因延迟、成本和复杂度而被拒绝
2. **关键词提取**：被拒绝，因为首段通常已足够用于技术文档
3. **N 句子提取**：曾考虑，但段落边界对 markdown 内容更自然

## 影响范围

- **影响规范**：`core-engine`（Markdown 解析）
- **影响文件**：
  - `packages/core/src/parser/mod.rs`（添加 `extract_summary` 函数）
  - `packages/core/src/storage/mod.rs`（应用智能摘要）
  - `packages/core/src/retriever/mod.rs`（更新文档注释）
- **破坏性变更**：无（摘要字段格式不变）
- **性能影响**：极小（简单字符串解析）
